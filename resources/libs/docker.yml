parameters:
    docker_images_prefix: ~
    docker_image_folder: ./docker/images/
    docker_shell: sh

commands:
    "docker:open":
        type: docker
        script: "%docker_shell%"
        options:
            target: "%1%"
            subtty: true
            flags: [interactive]
        shortDescription: Open shell in target container.
        longDescription: Need a target environment name.
        aliases: [open]

    "docker:log":
        script: docker-compose logs -f %_all%
        shortDescription : Display logs.
        aliases: [log]

    "docker:reboot":
        script: docker-compose halt && docker-compose up -d %_all%
        shortDescription: Reboot all containers.
        aliases: [reboot]

    "docker:up":
        script: docker-compose up -d %_all%
        shortDescription: Starts containers as daemons.
        aliases: [up]

    "docker:build":
        script:
            - docker build %docker_image_folder%%1% --tag %docker_images_prefix%%1%:latest %_left%
            - docker-compose up -d %1%
        shortDescription: Rebuilt a container locally.
        aliases: [build]

    "docker:clean":
        script:
            - docker-compose down --remove-orphans
            - array://docker system prune -a --volumes
        shortDescription: Cleaning unused Docker images and volumes.
        aliases: [clean]

    "docker:down":
        script: docker-compose down --remove-orphans %_all%
        shortDescription: Disable Docker containers.
        aliases: [down]

    "docker:restart":
        script: docker stop %1% && docker start %1%
        shortDescription: Restart target container.
        aliases: [restart]

    "docker-compose:in":
        script: docker cp %2% `docker-compose ps -q %1%`:%3%
        shortDescription: Copy a file or directory from outside to a container.
        longDescription: |
            Usage : qq cpin <container> <source> <target>
            <container> is the name of the container. (Use docker-compose names)
            <source> is the path to the source on the host.
            <target> is the path to the target inside the container.
            All arguments are required.
        aliases: [cpin]

    "docker-compose:out":
        script: docker cp `docker-compose ps -q %1%`:%2% %3%
        shortDescription: Copy a file or directory from a container to the outside.
        longDescription: |
            Usage : qq cpout <container> <source> <target>
            <container> is the name of the container. (Use docker-compose names)
            <source> is the path to the source inside the container.
            <target> is the path to the target on the host.
            All arguments are required.
        aliases: [cpout]

    "docker:wait":
        script: ./vendor/worldfactory/qq/resources/bin/docker-waiting-logs.sh "%_all%"
        shortDescription: Displays docker logs until you find a match, then hands over to the user.
        longDescription: |
            Usage : qq docker:wait <pattern>
            <pattern> is the pattern to hands over to the user. (Required - Do not add quotes)
            This command is intended to be used to delay a script while an event occurs inside the containers.
            The event must be visible in the logs.

    "docker:ps":
        script: |
            docker-compose ps | sed --unbuffered \
            -e 's/\(%ENV:COMPOSE_PROJECT_NAME%[a-zA-Z0-9_-]*\)/\o033[96m\1\o033[39m/g' \
            -e 's/\([0-9]*\(\.[0-9]*\)*\:[0-9]*\)/\o033[93m\1\o033[39m/g' \
            -e 's/\([0-9]*\/\(tcp\|udp\)\)/\o033[32m\1\o033[39m/g' \
            -e 's/\(Up      \)/\o033[42m   Up   \o033[49m/g' \
            -e 's/\(Exit [0-9]*  \)/\o033[101m Exited \o033[49m Status : \1/g' \
            -e 's/\(Paused  \)/\o033[101m Paused \o033[49m/g'
        aliases: [ps]
